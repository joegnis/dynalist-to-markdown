/*
 * Get exported Dynalist text from clipboard, convert it to Markdown
 * format, save it to a new Markdown record in currently opened group in
 * DEVONthink 3 app.
 *
 * Headings start from level 1, with max depth 1.
 * First heading is used as record name.
 */
var app = Application.currentApplication();
app.includeStandardAdditions = true;
var Devon = Application("com.devon-technologies.think3");

function addToNewRecord(name, content, group) {
    Devon.createRecordWith(
        {name: name, type: 'markdown', 'plain text': content},
        {in: group}
    );
}

function pasteToClipboard(content) {
    app.setTheClipboardTo(content);
}

(function() {
    'use strict';

    var clipboard = app.theClipboard().replace(/\r/g, '\n');
    var md = app.doShellScript('/usr/local/bin/python3 -m dynalist_to_md \
        --start-heading {{ start_heading }} --heading-depth {{ heading_depth }} "' + clipboard + '"')
        .replace(/\r/g, '\n');

    {% if dest is eq "new_record_cur_group" %}
    var title = md.match(/^#+ (.*)/)[1];
    addToNewRecord(title, md, Devon.currentGroup);
    {% elif dest is eq "clipboard" %}
    pasteToClipboard(md);
    {% endif %}
})();
